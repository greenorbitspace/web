---
import '../styles/global.css';
import '../styles/transitions.css';

import getGlobalSchema from '../components/Schema/GlobalSchema';
import Seo from '../components/Seo.astro';
import Analytics from '../components/Analytics.astro';
import CookieBanner from '../components/CookieBanner.astro';

export interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  canonical?: string;
  twitter?: { title?: string; description?: string; image?: string };
  schema?: Record<string, any> | Record<string, any>[];
}

const { title, description, ogImage, canonical, twitter, schema } = Astro.props;

// Fallback values
const fallbackTitle = 'Green Orbit Digital â€” Sustainable Marketing for the Space Sector';
const fallbackDescription =
  'Green Orbit Digital is a Leicester-based agency specialising in sustainable marketing for the space sector, delivering SEO, digital strategy, and data-driven campaigns.';
const fallbackImage = 'https://greenorbit.space/logos/organisations/greenorbit.png';
const pageUrl = canonical || 'https://greenorbit.space';

// Merge global schema, optional schema, and dynamic WebPage schema
let mergedSchema: Record<string, any>[] = [
  ...getGlobalSchema({
    url: pageUrl,
    title: title || fallbackTitle,
    description: description || fallbackDescription,
    featuredImage: ogImage || fallbackImage
  }),
  ...(Array.isArray(schema) ? schema : schema ? [schema] : [])
];

// Remove undefined recursively
function removeUndefined(obj: any): any {
  if (Array.isArray(obj)) return obj.map(removeUndefined);
  if (obj && typeof obj === 'object') {
    return Object.fromEntries(
      Object.entries(obj)
        .filter(([_, v]) => v !== undefined)
        .map(([k, v]) => [k, removeUndefined(v)])
    );
  }
  return obj;
}
mergedSchema = removeUndefined(mergedSchema);
---

<!DOCTYPE html>
<html
  lang="en"
  class="scroll-smooth"
  x-data="{ darkMode: localStorage.theme === 'dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme: dark)').matches) }"
  x-bind:class="{ 'dark': darkMode }"
>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" href="/favicon.ico" sizes="any" />

    <!-- SEO Meta -->
    <Seo
      title={title || fallbackTitle}
      description={description || fallbackDescription}
      ogImage={ogImage || fallbackImage}
      canonical={canonical}
      twitter={twitter}
    />

    <!-- JSON-LD schema -->
    <script type="application/ld+json" set:html={JSON.stringify(mergedSchema)} />

    {Astro.head}

    <!-- Analytics -->
    <Analytics
      gtmId={import.meta.env.PUBLIC_GTM_ID}
      ga4Id={import.meta.env.PUBLIC_GA4_ID}
      hubspotId={import.meta.env.PUBLIC_HUBSPOT_ID}
      hotjarId={import.meta.env.PUBLIC_HOTJAR_ID}
      hotjarVersion={import.meta.env.PUBLIC_HOTJAR_VERSION}
      brevoSiteId={import.meta.env.PUBLIC_BREVO_SITE_ID}
      ticketTailorTracking={import.meta.env.PUBLIC_TICKET_TAILOR}
    />

    <!-- Alpine.js -->
    <script
      type="module"
      src="https://unpkg.com/alpinejs@3.14.2/dist/cdn.min.js"
      defer
    ></script>
  </head>

  <body
    class="antialiased bg-white dark:bg-primary-500 text-secondary-500 dark:text-secondary-500 transition-colors duration-300"
  >
    <main id="page-wrapper" class="page-wrapper" role="main" tabindex="-1">
      <slot />
    </main>

    <CookieBanner />
  </body>
</html>
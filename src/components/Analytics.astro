---
const { ga4Id = import.meta.env.PUBLIC_GA4_ID } = Astro.props;
---

<!-- Load GA4 script statically so Google can detect it -->
{ga4Id && ga4Id.trim() !== "" && (
  <script async src={`https://www.googletagmanager.com/gtag/js?id=${ga4Id.trim()}`}></script>
)}

<script is:inline>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

// Only configure GA4 after analytics consent
function configureGA4() {
  if (!ga4Id || ga4Id.trim() === "") return;
  gtag('js', new Date());
  gtag('config', ga4Id.trim());
}

// Load immediately if consent already given
if (window.CookieYes?.consent?.analytics) {
  configureGA4();
}

// Listen for consent given later
window.addEventListener('cookies:analytics-accepted', () => {
  configureGA4();
});
</script>
---
const { ga4Id = import.meta.env.PUBLIC_GA4_ID } = Astro.props;
---

<script is:inline>
function initGA4(id) {
  if (!id) return;

  // Avoid duplicate script
  if (!document.querySelector(`script[src*="${id}"]`)) {
    const gtagScript = document.createElement('script');
    gtagScript.async = true;
    gtagScript.src = `https://www.googletagmanager.com/gtag/js?id=${id}`;
    document.head.appendChild(gtagScript);
  }

  // Initialize GA4
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', id);
}

// Load GA4 if analytics consent exists
if (window.CookieYes?.consent?.analytics) {
  initGA4(ga4Id?.trim());
}

// Listen for consent given later
window.addEventListener('cookies:analytics-accepted', () => {
  initGA4(ga4Id?.trim());
});
</script>
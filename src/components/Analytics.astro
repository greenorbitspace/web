---
// src/components/Analytics.astro

const {
  gtmId = import.meta.env.PUBLIC_GTM_ID, // GTM container ID (e.g., G-XXXXXXX)
  hubspotId = import.meta.env.PUBLIC_HUBSPOT_ID,
  hotjarId = import.meta.env.PUBLIC_HOTJAR_ID,
  hotjarVersion = import.meta.env.PUBLIC_HOTJAR_VERSION || "6",
  brevoSiteId = import.meta.env.PUBLIC_BREVO_SITE_ID,
  ticketTailorTracking = import.meta.env.PUBLIC_TICKET_TAILOR || "false"
} = Astro.props;
---

<script is:inline>
  function loadAnalytics() {
    // Google Tag Manager
    {gtmId && `
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
      j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','${gtmId}');
    `}

    // HubSpot
    {hubspotId && `
      const hsScript = document.createElement('script');
      hsScript.src = "//js.hs-scripts.com/${hubspotId}.js";
      hsScript.async = true;
      hsScript.defer = true;
      document.head.appendChild(hsScript);
    `}

    // Hotjar
    {hotjarId && `
      (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:${hotjarId},hjsv:${hotjarVersion}};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
      })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
    `}

    // Brevo (Sendinblue)
    {brevoSiteId && `
      const brevoScript = document.createElement('script');
      brevoScript.src = "https://cdn.brevo.com/js/sdk-loader.js";
      brevoScript.async = true;
      document.head.appendChild(brevoScript);
      window.Brevo = window.Brevo || [];
      Brevo.push(["init",{client_key:"${brevoSiteId}"}]);
      window.addEventListener("brevo:conversion",function(e){
        const {id="newsletter_signup",value=1}=e.detail||{};
        Brevo.push(["track","conversion",{id,value}]);
        if(typeof dataLayer!=="undefined") dataLayer.push({event:"BrevoConversion",id,value});
        if(window._hsq) window._hsq.push(["trackEvent",{id:"brevo_signup",value,eventName:id}]);
        console.log("üìù Brevo Conversion Sent:",{id,value});
      });
    `}

    // Ticket Tailor
    if (ticketTailorTracking === "true" && window.location.pathname.includes("thank-you")) {
      const ttScript = document.createElement('script');
      ttScript.src = "https://cdn.tickettailor.com/js/analytics.js";
      ttScript.async = true;
      document.head.appendChild(ttScript);
      window.ttq = window.ttq || [];
      const params = new URLSearchParams(window.location.search);
      const amount = parseFloat(params.get("amount")) || 0;
      const currency = params.get("currency") || "GBP";
      const event = params.get("event") || "TicketPurchase";
      const orderId = params.get("order_id") || Date.now().toString();
      window.ttq.push(['track','Purchase',{value:amount,currency,event_id:event+"_"+orderId}]);
      if(typeof dataLayer!=="undefined") dataLayer.push({event:"TicketPurchase",transaction_id:orderId,value:amount,currency,event});
      if(window._hsq) window._hsq.push(["trackEvent",{id:"ticket_purchase",value:amount,currency,orderId,eventName:event}]);
      console.log("üéüÔ∏è Ticket Tailor Conversion Sent:",{amount,currency,event,orderId});
    }
  }

  // Initialize only if user consented
  if (window.CookieYes?.consent?.analytics) loadAnalytics();
  window.addEventListener('cookies:analytics-accepted', loadAnalytics);
</script>
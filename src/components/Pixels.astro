---
// src/components/Pixels.astro

const {
  facebookPixelId = import.meta.env.PUBLIC_FACEBOOK_PIXEL_ID,
  linkedinPixelId = import.meta.env.PUBLIC_LINKEDIN_PIXEL_ID,
  twitterPixelId = import.meta.env.PUBLIC_TWITTER_PIXEL_ID,
  youtubePixelId = import.meta.env.PUBLIC_YOUTUBE_PIXEL_ID
} = Astro.props;
---

<script is:inline>
  function loadSocialPixels() {
    // Facebook / Meta Pixel
    {facebookPixelId && `
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init','${facebookPixelId}');
      fbq('track','PageView');
    `}

    // LinkedIn Insight Tag
    {linkedinPixelId && `
      _linkedin_partner_id = "${linkedinPixelId}";
      window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
      window._linkedin_data_partner_ids.push(_linkedin_partner_id);
      const s = document.createElement('script');
      s.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
      s.async = true;
      document.head.appendChild(s);
    `}

    // Twitter Universal Website Tag
    {twitterPixelId && `
      !function(e,t,n,s,u,a){
        e.twq||(s=e.twq=function(){s.exe?s.exe.apply(s,arguments):s.queue.push(arguments);
        },s.version='1.1',s.queue=[],u=t.createElement(n),u.async=!0,u.src='https://static.ads-twitter.com/uwt.js',
        a=t.getElementsByTagName(n)[0],a.parentNode.insertBefore(u,a))}(window,document,'script');
      twq('init','${twitterPixelId}');
      twq('track','PageView');
    `}

    // YouTube / Google Ads Conversion Pixel
    {youtubePixelId && `
      (function(){
        const gtagScript = document.createElement('script');
        gtagScript.src = "https://www.googletagmanager.com/gtag/js?id=${youtubePixelId}";
        gtagScript.async = true;
        document.head.appendChild(gtagScript);
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config','${youtubePixelId}');
      })();
    `}
  }

  // Initialize pixels only if user consented
  if (window.CookieYes?.consent?.analytics) {
    loadSocialPixels();
  }

  // Listen for consent event
  window.addEventListener('cookies:analytics-accepted', loadSocialPixels);
</script>
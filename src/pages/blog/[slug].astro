---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import HeroSection from '../../components/HeroSection.astro';
import { getCollection } from 'astro:content';
import authors from '../../data/authors.js';
import crypto from 'crypto';
import { slug as slugify } from 'github-slugger';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.slug ?? post.id },
  }));
}

const { slug } = Astro.params;
const posts = await getCollection('blog');
const postEntry = posts.find(p => p.slug === slug || p.id === slug);

if (!postEntry) throw new Error(`No blog post found for slug: "${slug}"`);

const { Content } = await postEntry.render();
const data = postEntry.data;

// Normalize frontmatter author name to slug for lookup
const authorSlug = slugify(data.author || '').toLowerCase();

// Find author by slug in authors array
const authorInfo = authors.find(a => a.slug === authorSlug) || null;

function getGravatarUrl(email, size = 80) {
  if (!email) return null;
  const hash = crypto.createHash('md5').update(email.trim().toLowerCase()).digest('hex');
  return `https://www.gravatar.com/avatar/${hash}?s=${size}&d=identicon`;
}

const avatarUrl = authorInfo?.gravatar && authorInfo.email
  ? getGravatarUrl(authorInfo.email)
  : authorInfo?.avatar || '/images/default-author.png';

const formattedDate = data.pubdate
  ? new Date(data.pubdate).toLocaleDateString('en-GB', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : null;

// Meta info
const pageTitle = data.seoTitle || data.title || 'Blog Post';
const pageDescription = data.seoDescription || data.description || data.title || 'Blog post on Green Orbit Digital';
const pageURL = `https://greenorbit.space/blog/${slug}`;
const pageAuthor = data.author || 'Green Orbit Digital';
const pageImage = data.featuredImage || '/default-og-image.jpg';

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: pageTitle,
  description: pageDescription,
  author: {
    "@type": "Person",
    name: pageAuthor,
  },
  datePublished: data.pubdate,
  url: pageURL,
  publisher: {
    "@type": "Organization",
    name: "Green Orbit Digital",
    logo: {
      "@type": "ImageObject",
      url: "https://greenorbit.space/logo.svg",
    },
  },
  ...(pageImage && { image: pageImage }),
};
---

<Layout title={pageTitle}>
  <Header />

  <main class="py-12">
    <HeroSection
      title="Blog"
      description="Explore our latest blog posts."
    />

    <main class="prose dark:prose-invert max-w-4xl mx-auto px-4 py-12">
      <article>
        <header class="mb-8">
          <h1 class="text-4xl font-bold text-accent-500 mb-2">{data.title}</h1>

            {authorInfo && (
              <div class="flex items-center gap-2 mt-4 text-sm text-white">
                <img src={avatarUrl} alt={authorInfo.name} class="w-6 h-6 rounded-full" />
                <span>
                  By <a href={`/authors/${authorInfo.slug}`} class="underline">{authorInfo.name}</a>
                </span>
                <span> Â· {formattedDate}</span>
              </div>
            )}

            {data.tags?.length && (
              <div class="mt-2 flex flex-wrap gap-2">
                {data.tags.map((tag) => (
                  <a
                    href={`/blog?tag=${encodeURIComponent(tag)}`}
                    class="text-xs bg-accent-600 text-white px-2 py-1 rounded hover:bg-accent-700 transition"
                  >
                    #{tag}
                  </a>
                ))}
              </div>
            )}
          </div>
        </header>

        <Content />
      </article>
    </main>

   <div class="container-custom">   
 <div class="mt-16 bg-accent-500 rounded-2xl p-8 md:p-12 relative overflow-hidden">
      <div class="relative z-10 text-center md:text-left md:flex items-center justify-between">
        <div class="mb-6 md:mb-0 md:mr-8">
          <h3 class="text-2xl md:text-3xl font-bold text-white mb-4">Ready to transform your business?</h3>
          <p class="text-white/80 max-w-2xl">Join thousands of satisfied customers who have improved their workflow with our platform.</p>
        </div>
        <a href="https://cal.com/rjmlaird" class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-medium transition-all duration-300 focus:outline-hidden focus:ring-2 focus:ring-offset-2 bg-white text-secondary-600 hover:bg-gray-100 focus:ring-white">
          Get Started Today
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </a>
      </div>
    </div>
    </div>
  <Footer />
</Layout>
---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import HeroSection from '../../components/HeroSection.astro';
import { getCollection } from 'astro:content';
import { SDGs } from '../../data/sdgs';

const collectionName = 'blog';
let entries = await getCollection(collectionName);

// Normalize tags
entries.forEach(entry => {
  if (entry.data.tags) {
    entry.data.tags = entry.data.tags.map(tag => tag.trim());
  }
});

// Sort entries by pubdate descending if available
entries = entries.sort((a, b) => {
  if (!a.data.pubdate) return 1;
  if (!b.data.pubdate) return -1;
  return new Date(b.data.pubdate) - new Date(a.data.pubdate);
});

// Tag library
const tagLibrary = [...new Set(entries.flatMap(e => e.data.tags ?? []))].sort((a,b) => a.localeCompare(b));

// Active tag
const url = new URL(Astro.request.url);
const activeTagParam = url.searchParams.get('tag')?.trim().toLowerCase();
const filteredEntries = activeTagParam
  ? entries.filter(entry => (entry.data.tags ?? []).some(tag => tag.toLowerCase() === activeTagParam))
  : entries;

// SDG map
const sdgMap = SDGs.reduce((acc, sdg) => {
  const code = `SDG ${String(sdg.id).padStart(2,'0')}`;
  acc[code.toUpperCase()] = sdg;
  return acc;
}, {});
---

<Layout title="Blog" description="Explore our latest blog posts on sustainable space operations.">
  <Header />

  <main class="py-12 w-full">
    <HeroSection title="Blog" description="Explore our latest blog posts on sustainability, space, and innovation." />

    <!-- Tag Filter -->
    {tagLibrary.length > 0 && (
      <div class="flex flex-wrap gap-2 mt-6 mb-8 justify-center">
        <a href="/blog" class={`px-3 py-1 rounded-full text-sm font-semibold ${!activeTagParam ? 'bg-accent-500 text-white' : 'bg-gray-700 text-white/80 hover:bg-accent-500'}`}>All</a>
        {tagLibrary.map(tag => (
          <a key={tag} href={`/blog?tag=${encodeURIComponent(tag)}`} class={`px-3 py-1 rounded-full text-sm font-semibold ${activeTagParam === tag.toLowerCase() ? 'bg-accent-500 text-white' : 'bg-gray-700 text-white/80 hover:bg-accent-500'}`}>#{tag}</a>
        ))}
      </div>
    )}

    <!-- blog Grid -->
    <ul id="blog-grid" class="grid gap-8 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 w-full px-4 sm:px-6 lg:px-8">
      {filteredEntries.slice(0, 6).map(entry => {
        const { title, excerpt, pubdate, tags = [], SDGs = [], featuredImage } = entry.data;
        const date = pubdate ? new Date(pubdate).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
        return (
          <li key={entry.slug} class="border border-accent-500 rounded-lg overflow-hidden hover:shadow-xl transition bg-white dark:bg-gray-800/40">
            <a href={`/blog/${entry.slug}`} class="block overflow-hidden rounded-t-lg">
              <img src={featuredImage || '/images/placeholder.jpg'} alt={title} loading="lazy" class="w-full h-48 md:h-56 lg:h-64 object-cover object-center transition-transform duration-300 hover:scale-105" />
            </a>
            <div class="p-4 space-y-2">
              <a href={`/blog/${entry.slug}`} class="block w-full">
                <h3 class="text-lg font-semibold bg-accent-500 text-white w-full px-3 py-2 rounded-md">{title}</h3>
              </a>
              {date && <p class="text-sm text-white">{date}</p>}
              {excerpt && <p class="text-gray-700 dark:text-gray-300 text-sm">{excerpt}</p>}

              <!-- Tags -->
              {tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-2">
                  {tags.map(tag => (
                    <a key={tag} href={`/blog?tag=${encodeURIComponent(tag)}`} class="bg-accent-500 text-white text-xs px-2 py-1 rounded hover:bg-accent-600 transition">#{tag}</a>
                  ))}
                </div>
              )}

              <!-- SDGs -->
              {SDGs.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-2">
                  {SDGs.map(id => {
                    const code = `SDG ${String(id).padStart(2,'0')}`;
                    const sdg = sdgMap[code.toUpperCase()];
                    return (
                      <a key={id} href={`https://sdgs.greenorbit.space/${id}/`} target="_blank" rel="noopener noreferrer">
                        <img src={sdg?.icon || '/sdgs/default.svg'} alt={sdg?.name || code} class="w-8 h-8 rounded-sm border border-gray-300/40 transition-transform hover:scale-110"/>
                      </a>
                    );
                  })}
                </div>
              )}
            </div>
          </li>
        );
      })}
    </ul>

    <!-- CTA Section -->
    <section class="mt-16 py-16 bg-secondary-500 text-white text-center w-full">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl sm:text-4xl font-bold mb-4">Stay Updated on Sustainable Space</h2>
        <p class="mb-8 text-lg sm:text-xl text-gray-200">Subscribe to our newsletter for the latest insights on space, sustainability, and innovation.</p>
        <a href="/blogletter" class="inline-block px-8 py-4 bg-accent-500 hover:bg-accent-600 text-white font-semibold rounded-lg transition text-lg sm:text-xl">Subscribe Now</a>
      </div>
    </section>
  </main>

  <Footer />
</Layout>
---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import HeroSection from '../../components/HeroSection.astro';
import InsightsList from '../../components/InsightsList.jsx';
import { getCollection } from 'astro:content';
import teams from '../../data/team.js';
import crypto from 'crypto';
import { slug as slugify } from 'github-slugger';

export async function getStaticPaths() {
  return teams.map(team => ({
    params: { team: team.slug }
  }));
}

const { team } = Astro.params;

const teamData = teams.find(a => a.slug.toLowerCase() === team.toLowerCase());
if (!teamData) throw new Error(`team not found: ${team}`);

const blogPosts = await getCollection('blog');
const newsItems = await getCollection('news');
const resourceItems = await getCollection('resources');

function annotateWithType(posts, type) {
  return posts.map(post => ({
    ...post,
    data: { ...post.data, contentType: type }
  }));
}

const allPosts = [
  ...annotateWithType(blogPosts, 'blog'),
  ...annotateWithType(newsItems, 'news'),
  ...annotateWithType(resourceItems, 'resource'),
];

// Filter posts by team slug (case-insensitive)
const teamPosts = allPosts.filter(post => {
  if (!post.data.team) return false;
  return slugify(post.data.team) === team.toLowerCase();
});

// Sort by pubdate descending (newest first)
teamPosts.sort((a, b) => {
  const dateA = new Date(a.data.pubdate ?? 0);
  const dateB = new Date(b.data.pubdate ?? 0);
  return dateB - dateA;
});

function getGravatarUrl(email) {
  if (!email) return null;
  const hash = crypto.createHash('md5').update(email.trim().toLowerCase()).digest('hex');
  return `https://www.gravatar.com/avatar/${hash}?s=80&d=identicon`;
}

const gravatarUrl = teamData.gravatar
  ? getGravatarUrl(teamData.email)
  : teamData.avatar || '/images/default-team.png';
---

<Layout title={`Insights by ${teamData.name}`} description={`Articles by ${teamData.name}`}>
  <Header />

  <main class="py-12 max-w-6xl mx-auto px-4">
    <HeroSection 
      title={`Insights by ${teamData.name}`} 
      description="Explore our latest insights across blog posts, news, and resources." 
    />

    <section class="flex items-center space-x-6 my-8">
      <img
        src={gravatarUrl}
        alt={teamData.name}
        class="w-20 h-20 rounded-full border border-gray-300"
      />
      <div>
        <h1 class="text-3xl font-bold">{teamData.name}</h1>
        {teamData.role && <p class="text-white">{teamData.role}</p>}
        {teamData.bio && <p class="mt-2 max-w-xl">{teamData.bio}</p>}

        <div class="flex space-x-4 mt-4">
          {teamData.twitter && (
            <a href={`https://twitter.com/${teamData.twitter}`} target="_blank" rel="noopener noreferrer" aria-label="Twitter" class="text-primary-600 hover:text-primary-800">
              {/* Twitter SVG omitted for brevity */}
            </a>
          )}
          {teamData.github && (
            <a href={`https://github.com/${teamData.github}`} target="_blank" rel="noopener noreferrer" aria-label="GitHub" class="text-primary-600 hover:text-primary-800">
              {/* GitHub SVG omitted for brevity */}
            </a>
          )}
          {teamData.linkedin && (
            <a href={`https://www.linkedin.com/in/${teamData.linkedin}`} target="_blank" rel="noopener noreferrer" aria-label="LinkedIn" class="text-primary-600 hover:text-primary-800">
              {/* LinkedIn SVG omitted for brevity */}
            </a>
          )}
          {teamData.website && (
            <a href={teamData.website} target="_blank" rel="noopener noreferrer" aria-label="Website" class="text-primary-600 hover:text-primary-800">
              {/* Website SVG omitted for brevity */}
            </a>
          )}
        </div>
      </div>
    </section>

    <section>
      <InsightsList client:load posts={teamPosts} />
    </section>
  </main>

  <Footer />
</Layout>
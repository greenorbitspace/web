---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import HeroSection from '../../components/HeroSection.astro';
import InsightsList from '../../components/InsightsList.jsx';
import { getCollection } from 'astro:content';
import authors from '../../data/authors.js';
import crypto from 'crypto';
import { slug as slugify } from 'github-slugger';

export async function getStaticPaths() {
  return authors.map(author => ({
    params: { author: author.slug }
  }));
}

const { author } = Astro.params;

const authorData = authors.find(a => a.slug.toLowerCase() === author.toLowerCase());
if (!authorData) throw new Error(`Author not found: ${author}`);

const blogPosts = await getCollection('blog');
const newsItems = await getCollection('news');
const resourceItems = await getCollection('resources');

function annotateWithType(posts, type) {
  return posts.map(post => ({
    ...post,
    data: { ...post.data, contentType: type }
  }));
}

const allPosts = [
  ...annotateWithType(blogPosts, 'blog'),
  ...annotateWithType(newsItems, 'news'),
  ...annotateWithType(resourceItems, 'resource'),
];

// Filter posts by author slug (case-insensitive)
const authorPosts = allPosts.filter(post => {
  if (!post.data.author) return false;
  return slugify(post.data.author) === author.toLowerCase();
});

// Sort by pubdate descending (newest first)
authorPosts.sort((a, b) => {
  const dateA = new Date(a.data.pubdate ?? 0);
  const dateB = new Date(b.data.pubdate ?? 0);
  return dateB - dateA;
});

function getGravatarUrl(email) {
  if (!email) return null;
  const hash = crypto.createHash('md5').update(email.trim().toLowerCase()).digest('hex');
  return `https://www.gravatar.com/avatar/${hash}?s=80&d=identicon`;
}

const gravatarUrl = authorData.gravatar
  ? getGravatarUrl(authorData.email)
  : authorData.avatar || '/images/default-author.png';
---

<Layout title={`Insights by ${authorData.name}`} description={`Articles by ${authorData.name}`}>
  <Header />

  <main class="py-12 max-w-6xl mx-auto px-4">
    <HeroSection 
      title={`Insights by ${authorData.name}`} 
      description="Explore our latest insights across blog posts, news, and resources." 
    />

    <section class="flex items-center space-x-6 my-8">
      <img
        src={gravatarUrl}
        alt={authorData.name}
        class="w-20 h-20 rounded-full border border-gray-300"
      />
      <div>
        <h1 class="text-3xl font-bold">{authorData.name}</h1>
        {authorData.role && <p class="text-white">{authorData.role}</p>}
        {authorData.bio && <p class="mt-2 max-w-xl">{authorData.bio}</p>}

        <div class="flex space-x-4 mt-4">
          {authorData.twitter && (
            <a href={`https://twitter.com/${authorData.twitter}`} target="_blank" rel="noopener noreferrer" aria-label="Twitter" class="text-primary-600 hover:text-primary-800">
              {/* Twitter SVG omitted for brevity */}
            </a>
          )}
          {authorData.github && (
            <a href={`https://github.com/${authorData.github}`} target="_blank" rel="noopener noreferrer" aria-label="GitHub" class="text-primary-600 hover:text-primary-800">
              {/* GitHub SVG omitted for brevity */}
            </a>
          )}
          {authorData.linkedin && (
            <a href={`https://www.linkedin.com/in/${authorData.linkedin}`} target="_blank" rel="noopener noreferrer" aria-label="LinkedIn" class="text-primary-600 hover:text-primary-800">
              {/* LinkedIn SVG omitted for brevity */}
            </a>
          )}
          {authorData.website && (
            <a href={authorData.website} target="_blank" rel="noopener noreferrer" aria-label="Website" class="text-primary-600 hover:text-primary-800">
              {/* Website SVG omitted for brevity */}
            </a>
          )}
        </div>
      </div>
    </section>

    <section>
      <InsightsList client:load posts={authorPosts} />
    </section>
  </main>

  <Footer />
</Layout>
---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import HeroSection from '../components/HeroSection.astro';
import InsightsList from '../components/InsightsList.jsx';
import { getCollection } from 'astro:content';
import { slug as slugify } from 'github-slugger';
import organisations from '../data/organisations.json';

// Fetch all collections
const blogPosts = await getCollection('blog');
const newsItems = await getCollection('news');
const resources = await getCollection('resources');

// Helper to tag entries with contentType for filtering/display
const formatEntries = (entries, type) =>
  entries.map(entry => ({
    ...entry,
    data: { ...entry.data, contentType: type }
  }));

const allInsights = [
  ...formatEntries(blogPosts, 'blog'),
  ...formatEntries(newsItems, 'news'),
  ...formatEntries(resources, 'resource')
];

// Sort by published date (latest first)
allInsights.sort(
  (a, b) => new Date(b.data.pubdate ?? 0) - new Date(a.data.pubdate ?? 0)
);

// Map organisation names to slugs for linking
const orgSlugMap = {};
organisations.forEach(org => {
  orgSlugMap[org.organisation] = org.slug;
});

// Replace organisation names in insights with objects { name, slug }
allInsights.forEach((item) => {
  if (Array.isArray(item.data.organisations)) {
    item.data.organisations = item.data.organisations.map((name) => ({
      name,
      slug: orgSlugMap[name] || slugify(name)
    }));
  }
});
---

<Layout title="Insights" description="Explore the latest blogs, news, and resources.">
  <Header />

  <main class="py-12 w-full">
    <!-- Hero section -->
    <div class="max-w-6xl mx-auto px-4">
      <HeroSection 
        title="Insights" 
        description="Explore articles, news, and knowledge resources from across our platform." 
      />
    </div>

    <!-- Insights list full width with some horizontal padding -->
    <div class="w-full px-4 md:px-8 lg:px-12">
      <InsightsList client:load posts={allInsights} />
    </div>

      <!-- CTA Section -->
    <section class="mt-16 py-16 bg-secondary-500 text-white text-center w-full">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl sm:text-4xl font-bold mb-4">Stay Updated on Sustainable Space</h2>
        <p class="mb-8 text-lg sm:text-xl text-gray-200">Subscribe to our newsletter for the latest insights on space, sustainability, and innovation.</p>
        <a href="/newsletter" class="inline-block px-8 py-4 bg-accent-500 hover:bg-accent-600 text-white font-semibold rounded-lg transition text-lg sm:text-xl">Subscribe Now</a>
      </div>
    </section>
  </main>

  <Footer />
</Layout>
---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import HeroSection from '../components/HeroSection.astro';
import PricingList from '../components/PricingList.jsx';

import Stripe from 'stripe';

const stripeSecretKey = import.meta.env.STRIPE_SECRET_KEY;

if (!stripeSecretKey) {
  throw new Error('STRIPE_SECRET_KEY environment variable is not set.');
}

const stripe = new Stripe(stripeSecretKey, {
  apiVersion: '2022-11-15',
});

// Fetch prices with expanded product data
const prices = await stripe.prices.list({
  active: true,
  limit: 100,
  expand: ['data.product'],
});

// Group prices by product and include category from product metadata
const productsMap = new Map();

for (const price of prices.data) {
  const product = price.product;
  if (!productsMap.has(product.id)) {
    productsMap.set(product.id, {
      id: product.id,
      product_name: product.name,
      description: product.description || '',
      images: product.images || [],
      category: product.metadata?.category || '', // Add product category here
      prices: [],
    });
  }
  productsMap.get(product.id).prices.push(price);
}

// Convert Map to sorted array alphabetically by product_name
const sortedProducts = Array.from(productsMap.values()).sort((a, b) =>
  a.product_name.localeCompare(b.product_name)
);
---

<Layout title="Pricing" description="Transparent pricing for our sustainable marketing services.">
  <Header />

  <main class="py-12 max-w-6xl mx-auto px-4">
    <HeroSection 
      title="Pricing" 
      description="Transparent pricing for our sustainable marketing services â€” tailored to the space, smart cities, and maritime sectors." 
    />

<section class="py-16 bg-white dark:bg-secondary-500">
      <PricingList products={sortedProducts} client:load />
    </section>
  </main>

  <Footer />
</Layout>
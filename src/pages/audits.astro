---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import HeroSection from '../components/HeroSection.astro';
---

<html lang="en">
<head>
  <title>Audits</title>
  <script src="https://js.stripe.com/v3/"></script>
</head>

<body>
  <Layout title="Audits">
    <Header />

    <main class="py-12">
      <HeroSection
        title="Audits"
        description="Choose a plan that fits your mission. All options include a 14-day free trial—no credit card required."
      />

      <section class="container mx-auto px-4 my-8 grid md:grid-cols-3 gap-8" id="plans-container">
        <div class="border p-6 rounded-xl shadow" data-product-name="Starter Plan" data-amount="4900">
          <h3 class="text-xl font-bold mb-2">Starter Plan</h3>
          <p class="mb-4">£49/month — Basic audit</p>
          <button class="choose-plan-btn bg-green-600 text-white px-4 py-2 rounded">
            Choose Plan
          </button>
        </div>
        <!-- Repeat similar plan divs or render dynamically -->
      </section>

      <script type="module">
        const stripe = Stripe(import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY);

        document.getElementById('plans-container').addEventListener('click', async (e) => {
          if (!e.target.classList.contains('choose-plan-btn')) return;

          const planDiv = e.target.closest('[data-product-name][data-amount]');
          if (!planDiv) return;

          const productName = planDiv.getAttribute('data-product-name');
          const amount = parseInt(planDiv.getAttribute('data-amount'), 10);

          try {
            const response = await fetch('/api/create-checkout-session', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ productName, amount }),
            });

            const { sessionId } = await response.json();

            const { error } = await stripe.redirectToCheckout({ sessionId });

            if (error) {
              alert(error.message);
            }
          } catch (err) {
            alert('Failed to start checkout. Please try again.');
            console.error(err);
          }
        });
      </script>
    </main>

    <Footer />
  </Layout>
</body>
</html>
---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import HeroSection from '../../components/HeroSection.astro';
import { getCollection } from 'astro:content';
import { SDGs } from '../../data/sdgs';
import { slug as slugify } from 'github-slugger';

export async function getStaticPaths() {
  const campaigns = await getCollection('campaigns');
  return campaigns.map(c => ({
    params: { slug: c.slug ?? c.id },
  }));
}

const { slug } = Astro.params;
const campaigns = await getCollection('campaigns');
const campaign = campaigns.find(c => c.slug === slug || c.id === slug);

if (!campaign) throw new Error(`No campaign found for slug: "${slug}"`);

const { Content } = await campaign.render();
const data = campaign.data;

const formattedMonth = data.month ?? null;
const campaignUrl = data.url ?? null;

const pageTitle = data.seoTitle || data.title || 'Campaign';
const pageDescription = data.seoDescription || data.description || data.title;
const pageURL = `https://greenorbit.space/campaigns/${slug}`;
const pageImage = data.featuredImage || '/default-og-image.jpg';

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Event",
  name: pageTitle,
  description: pageDescription,
  url: campaignUrl || pageURL,
  ...(formattedMonth && { startDate: formattedMonth }),
  ...(pageImage && {
    image: [pageImage]
  }),
  location: {
    "@type": "Place",
    name: "Green Orbit Digital",
    address: {
      "@type": "PostalAddress",
      addressCountry: "UK"
    }
  }
};

const sdgMap = SDGs.reduce((acc, sdg) => {
  const code = `SDG ${String(sdg.id).padStart(2, '0')}`;
  acc[code.toUpperCase()] = sdg;
  return acc;
}, {});

let sdgCodes = [];
if (Array.isArray(data.SDGs)) {
  sdgCodes = data.SDGs
    .filter(n => typeof n === 'number')
    .map(n => `SDG ${String(n).padStart(2, '0')}`);
} else if (typeof data.SDGs === 'number') {
  sdgCodes = [`SDG ${String(data.SDGs).padStart(2, '0')}`];
}
---

<Layout title={pageTitle} description={pageDescription}>
  <Header />

  <main class="py-12">
    <HeroSection
      title="Campaigns"
      description="Explore space-themed campaigns and sustainability outreach events."
    />

    <main class="prose dark:prose-invert max-w-4xl mx-auto px-4 py-12">
      <article>
        <header class="mb-8">
          <h1 class="text-4xl font-bold text-accent-500 mb-2">{data.title}</h1>

          {formattedMonth && (
            <p class="text-sm text-white mt-2">ðŸ“… {formattedMonth}</p>
          )}

          {campaignUrl && (
            <p class="mt-2">
              ðŸ”— <a href={campaignUrl} class="underline text-accent-400" target="_blank" rel="noopener noreferrer">
                Visit Campaign Site
              </a>
            </p>
          )}

          {data.organisations?.length > 0 && (
            <div class="mt-4 flex flex-wrap gap-2">
              {data.organisations.map((org) => (
                <span
                  key={org}
                  class="bg-gray-300 dark:bg-accent-500 text-white rounded-full px-3 py-1 text-xs font-medium capitalize"
                >
                  {org}
                </span>
              ))}
            </div>
          )}

          {data.tags?.length > 0 && (
            <div class="mt-4 flex flex-wrap gap-2">
              {data.tags.map((tag) => (
                <a
                  key={tag}
                  href={`/campaigns?tag=${encodeURIComponent(tag)}`}
                  class="text-xs bg-accent-600 text-white px-2 py-1 rounded hover:bg-accent-700 transition"
                >
                  #{tag}
                </a>
              ))}
            </div>
          )}

          {sdgCodes.length > 0 && (
            <div class="mt-4 flex flex-wrap gap-2">
              {sdgCodes.map((code) => {
                const sdg = sdgMap[code];
                if (!sdg) return null;
                return (
                  <a
                    key={code}
                    href={`https://sdgs.greenorbit.space/${sdg.id}/`}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="group"
                    aria-label={`View details about ${sdg.name}`}
                  >
                    <img
                      src={sdg.icon}
                      alt={sdg.name}
                      class="w-10 h-10 rounded-sm border border-gray-300 dark:border-gray-600"
                    />
                  </a>
                );
              })}
            </div>
          )}
        </header>

        <section class="prose prose-invert max-w-none">
          <Content />
        </section>
      </article>
    </main>

    <Footer />

    <script type="application/ld+json">
      {JSON.stringify(jsonLd)}
    </script>
  </main>
</Layout>
---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import HeroSection from '../../components/HeroSection.astro';
import { getCollection } from 'astro:content';
import { SDGs } from '../../data/sdgs';

// Get campaign paths
export async function getStaticPaths() {
  const campaigns = await getCollection('campaigns');
  return campaigns.map(c => ({
    params: { slug: c.slug ?? c.id },
  }));
}

// Current campaign
const { slug } = Astro.params;
const campaigns = await getCollection('campaigns');
const campaignEntry = campaigns.find(c => c.slug === slug || c.id === slug);

if (!campaignEntry) throw new Error(`No campaign found for slug: "${slug}"`);

const { Content } = await campaignEntry.render();
const data = campaignEntry.data;

// Frontmatter defaults
const formattedMonth = data.month ?? null;
const campaignUrl = data.url ?? null;

// Full support for UN Resolution field
const unResolution = data.unResolution ?? data['un-resolution'] ?? null;

const pageTitle = data.seoTitle || data.title || 'Campaign';
const pageDescription = data.seoDescription || data.description || data.title;
const pageURL = `https://greenorbit.space/campaigns/${slug}`;
const pageImage = data.featuredImage || '/default-og-image.jpg';

// JSON-LD structured data
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Event",
  name: pageTitle,
  description: pageDescription,
  url: campaignUrl || pageURL,
  ...(formattedMonth && { startDate: formattedMonth }),
  ...(pageImage && { image: [pageImage] }),
  ...(unResolution && {
    legislation: {
      "@type": "Legislation",
      name: `UN Resolution ${unResolution}`,
      legislationIdentifier: unResolution
    }
  }),
  location: {
    "@type": "Place",
    name: "Green Orbit Digital",
    address: {
      "@type": "PostalAddress",
      addressCountry: "UK"
    }
  }
};

// SDG map
const sdgMap = SDGs.reduce((acc, sdg) => {
  const code = `SDG ${String(sdg.id).padStart(2, '0')}`;
  acc[code.toUpperCase()] = sdg;
  return acc;
}, {});

// SDG normalization
let sdgCodes = [];
if (Array.isArray(data.SDGs)) {
  sdgCodes = data.SDGs
    .filter(n => typeof n === 'number')
    .map(n => `SDG ${String(n).padStart(2, '0')}`);
} else if (typeof data.SDGs === 'number') {
  sdgCodes = [`SDG ${String(data.SDGs).padStart(2, '0')}`];
}
---

<Layout title={pageTitle} description={pageDescription}>
  <Header />

  <main class="py-12">
    <HeroSection
      title="Campaigns"
      description="Explore space-themed campaigns and sustainability outreach events."
    />

    <section class="prose dark:prose-invert max-w-4xl mx-auto px-4 py-12">
      <article>
        <header class="mb-8">
          <h1 class="text-4xl font-bold text-accent-500 mb-2">{data.title}</h1>

          {formattedMonth && <p class="text-sm text-gray-400 mt-2">ðŸ“… {formattedMonth}</p>}

            {unResolution && (
              <p class="mt-2 text-sm text-gray-400">
                <strong>UN Resolution:</strong>{' '}
                <a
                  href={`https://undocs.org/${encodeURIComponent(unResolution.replace(/\s+/g, '').replace(/$begin:math:text$/g,'%28').replace(/$end:math:text$/g,'%29'))}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-accent-500 hover:underline"
                >
                  {unResolution}
                </a>
              </p>
            )}

          {data.organisations?.length > 0 && (
            <div class="mt-4 flex flex-wrap gap-2">
              {data.organisations.map(org => (
                <span
                  key={org}
                  class="inline-block bg-gray-300 dark:bg-accent-500 text-white rounded px-2 py-1 text-xs font-medium cursor-default"
                >
                  {org}
                </span>
              ))}
            </div>
          )}

          {data.tags?.length > 0 && (
            <div class="mt-4 flex flex-wrap gap-2">
              {data.tags.map(tag => (
                <a
                  key={tag}
                  href={`/campaigns?tag=${encodeURIComponent(tag)}`}
                  class="text-xs bg-accent-600 text-white px-2 py-1 rounded hover:bg-accent-700 transition"
                >
                  #{tag}
                </a>
              ))}
            </div>
          )}

          {sdgCodes.length > 0 && (
            <div class="mt-4 flex flex-wrap gap-2">
              {sdgCodes.map(code => {
                const sdg = sdgMap[code];
                if (!sdg) return null;
                return (
                  <a
                    key={code}
                    href={`https://sdgs.greenorbit.space/${sdg.id}/`}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="group"
                    aria-label={`View details about ${sdg.name}`}
                  >
                    <img
                      src={sdg.icon}
                      alt={sdg.name}
                      class="w-12 h-12 rounded-sm border border-gray-300 dark:border-gray-600"
                    />
                  </a>
                );
              })}
            </div>
          )}
        </header>

        <section class="prose prose-invert max-w-none">
          <Content />
        </section>

        {campaignUrl && (
          <div class="mt-8 text-center">
            <a
              href={campaignUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="btn-primary no-underline"
              aria-label={`Learn more about ${data.title}`}
            >
              View Campaign
            </a>
          </div>
        )}
      </article>
    </section>

    <Footer />

    <script type="application/ld+json">
      {JSON.stringify(jsonLd)}
    </script>
  </main>
</Layout>